<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GNSS Sky Plot</title>
  <style>
    /* Center the plot container */
    #skyplot {
      width: 500px;
      height: 500px;
      margin: 20px auto;
    }
    /* Legend styling */
    #legend {
      width: 300px;
      margin: 10px auto;
      text-align: center;
      font-family: sans-serif;
      font-size: 12px;
    }
    #legend svg {
      width: 100%;
      height: 20px;
    }
    #legend .labels {
      display: flex;
      justify-content: space-between;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div id="skyplot" xstyle="background-color:yellow"></div>


  <div id="legend">
    <div>Signal-to-Noise Ratio (dB-Hz)</div>
    <svg>
      <defs>
        <linearGradient id="snrGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="red" />
          <stop offset="30%" stop-color="yellow" />
          <stop offset="50%" stop-color="green" />
          <stop offset="80%" stop-color="blue" />
          <stop offset="100%" stop-color="violet" />
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="100%" height="100%" fill="url(#snrGradient)" />
    </svg>
    <div class="labels">
      <span>20 dB-Hz (Poor)</span>
      <span>50 dB-Hz (Good)</span>
    </div>
  </div>


  <script type="module">
    // Import the SkyPlot module
    import SkyPlot from './skyplot.js';

    // Create a new plot instance
    const plot = new SkyPlot({
      container: '#skyplot',
      size: 500,
      historyLength: 50
    });

    // Function to fetch GSV sentences from the service and update the plot
    async function fetchGSV() {
      try {
        //const res = await fetch('http://em.wombat.ie:5005/stations');
        const res = await fetch('https://em.wombat.ie/fe/GNSS_Java/chart/basestation2.json');
console.log("res=",res);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const stations = await res.json();
console.log("stations.length=",stations.length,stations);
	stations.forEach(function(station) {
console.log("  station=",station);
		if (station.mountpoint !== "galway_east") {
			return;
		}
console.log(" *** found station");
		station.statusUpdates.forEach(function(update) {
        		// Expecting an array of NMEA GPGSV (and similar) sentence strings
			const gsvSentences = update.gsvSentences.split("\r\n");
console.log("    gsvSentences=",gsvSentences);
			plot.update(gsvSentences);
			//gsvSentences.forEach(function(gsv) {
        		//	plot.update(gsv);
			//});
		});

	});


      } catch (err) {
        console.error('Error fetching GSV data:', err);
      }
    }

    // Initial fetch and update
    fetchGSV();
    // Poll every 5 seconds
    setInterval(fetchGSV, 5000);
  </script>
</body>
</html>

